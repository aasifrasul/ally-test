services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - '3100:3100'
        environment:
            ENV: ${ENV:-development}
            POSTGRES_HOST: pgbouncer
            POSTGRES_PORT: 6432
            POSTGRES_DB: ${POSTGRES_DB:-test}
            POSTGRES_USER: ${POSTGRES_USER:-test}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-test}
            MYSQL_HOST: mysql
            MYSQL_PORT: 3306
            MYSQL_DATABASE: ${MYSQL_DATABASE:-test}
            MYSQL_USER: ${MYSQL_USER:-test}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD:-test}
            MONGODB_HOST: mongodb
            MONGODB_PORT: 27017
            MONGODB_USER: ${MONGODB_USER:-test}
            MONGODB_PASSWORD: ${MONGODB_PASSWORD:-test}
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_URL: redis://redis:6379
        depends_on:
            pgbouncer:
                condition: service_healthy
            mysql:
                condition: service_healthy
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        volumes:
            - .:/app
            - /app/node_modules
        networks:
            - app-network
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--quiet',
                    '--tries=1',
                    '--spider',
                    'http://localhost:3100/health',
                    '||',
                    'exit',
                    '1',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        restart: unless-stopped
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        deploy:
            resources:
                limits:
                    cpus: '2'
                    memory: 2G
                reservations:
                    memory: 512M

    pgbouncer:
        image: bitnami/pgbouncer:1.23.1
        environment:
            - POSTGRESQL_HOST=postgres
            - POSTGRESQL_PORT=5432
            - POSTGRESQL_DATABASE=${POSTGRES_DB:-test}
            - POSTGRESQL_USERNAME=${POSTGRES_USER:-test}
            - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD:-test}
            - PGBOUNCER_PORT=6432
            - PGBOUNCER_AUTH_TYPE=md5
            - PGBOUNCER_POOL_MODE=transaction
            - PGBOUNCER_MAX_CLIENT_CONN=1000
            - PGBOUNCER_DEFAULT_POOL_SIZE=20
            - PGBOUNCER_MIN_POOL_SIZE=5
            - PGBOUNCER_RESERVE_POOL_SIZE=5
            - PGBOUNCER_RESERVE_POOL_TIMEOUT=3
        ports:
            - '6432:6432'
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - app-network
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    "PGPASSWORD=${POSTGRES_PASSWORD:-test} psql -h localhost -p 6432 -U ${POSTGRES_USER:-test} -d ${POSTGRES_DB:-test} -c 'SELECT 1' || exit 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        restart: unless-stopped
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    postgres:
        image: postgres:17-alpine
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-test}
            POSTGRES_USER: ${POSTGRES_USER:-test}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-test}
            PGDATA: /var/lib/postgresql/data/pgdata
        ports:
            - '5432:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
        restart: unless-stopped
        networks:
            - app-network
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-test} -d ${POSTGRES_DB:-test}']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        security_opt:
            - no-new-privileges:true
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 256M

    mysql:
        image: mysql:8.0
        command: >
            --default-authentication-plugin=mysql_native_password
            --innodb-buffer-pool-size=512M
            --max-connections=500
            --innodb-flush-log-at-trx-commit=2
            --innodb-log-buffer-size=16M
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
            MYSQL_DATABASE: ${MYSQL_DATABASE:-test}
            MYSQL_USER: ${MYSQL_USER:-test}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD:-test}
        ports:
            - '3306:3306'
        volumes:
            - mysql_data:/var/lib/mysql
        restart: unless-stopped
        networks:
            - app-network
        healthcheck:
            test:
                [
                    'CMD',
                    'mysqladmin',
                    'ping',
                    '-h',
                    'localhost',
                    '-u',
                    '${MYSQL_USER:-test}',
                    '-p${MYSQL_PASSWORD:-test}',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        security_opt:
            - no-new-privileges:true
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 256M

    mongodb:
        image: mongo:8.0
        command: --wiredTigerCacheSizeGB 1.5
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-test}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-test}
            MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-test}
        ports:
            - '27017:27017'
        volumes:
            - mongodb_data:/data/db
            - mongodb_config:/data/configdb
        restart: unless-stopped
        networks:
            - app-network
        healthcheck:
            test: ['CMD', 'mongosh', '--quiet', '--eval', "db.adminCommand('ping').ok"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        security_opt:
            - no-new-privileges:true
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 512M

    redis:
        image: redis:7.4-alpine
        command: >
            redis-server
            --maxmemory 256mb
            --maxmemory-policy allkeys-lru
            --appendonly yes
            --requirepass ${REDIS_PASSWORD:-}
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data
        healthcheck:
            test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        restart: unless-stopped
        networks:
            - app-network
        security_opt:
            - no-new-privileges:true
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 128M

volumes:
    postgres_data:
        driver: local
    mysql_data:
        driver: local
    mongodb_data:
        driver: local
    mongodb_config:
        driver: local
    redis_data:
        driver: local

networks:
    app-network:
        driver: bridge
# Usage Commands:
# ===============
# Start all services:          docker compose up -d --build
# Start specific service:      docker compose up -d --build mongodb
# Stop all services:           docker compose down
# Stop and remove volumes:     docker compose down -v
# View logs:                   docker compose logs -f [service_name]
# Restart service:             docker compose restart [service_name]
# Check service health:        docker compose ps
#
# On Linux (restart Docker):   sudo systemctl restart docker
